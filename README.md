# raiiaa-one-service

The REST API that powers all the raiiaa.dev projects.

---

# Database

This project uses `sqlc` and `goose` to manage database migrations and generate type-safe database access code.

## Migrations

### Create

The migrations files are generated by `goose` but the SQL must be written by hand, writing both up and down queries for the migration. To generate a migration you run the following command:

```bash
  goose -s create <migration_name> sql    # This will add a .sql file into the migrations folder
```

This will generate the `.sql` file at your currenct folder, unless it has a `.env` file to configurate some of the behaviors of goose. Example (more about goose can be found in [goose's website](https://pressly.github.io/goose/)):

```
GOOSE_DRIVER=The database driver to use
GOOSE_DBSTRING=The database connection string
GOOSE_MIGRATION_DIR=The directory containing the migration files (default: .)
NO_COLOR=Disable color output
```

After that you write your own SQL code to add for the migration:

```sql
-- +goose Up
-- +goose StatementBegin
CREATE TABLE IF NOT EXISTS products (
    id BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    price_in_cents INTEGER NOT NULL CHECK (price_in_cents >= 0),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
DROP TABLE IF EXISTS products;
-- +goose StatementEnd
```

### Push the migrations

To push the migrations, you just need to execute this command:

```bash
goose up # Pushed to the database
```

## Type-safe models and queries

While `goose` is a good tool to handle database migrations, `sqlc` removes the headache of building every type and every repository or DAO to access the data inside the database. The `sqlc` tool integrates really well with `goose` because you'll only need to write SQL code again.

To start, you'll need to touch the `sqlc.yaml` file to configure the tool. More about the configuration can be found in [sqlc's website](https://sqlc.dev/).

### Generated code

Before generating any code, you need to write the SQL queries (like the functions of a repository) you wanna make. Here is an example of a SQL file that contains some queries for the `products` table we created before:

```sql
-- name: CreateProduct :one
INSERT INTO products (name, price_in_cents)
VALUES ($1, $2)
RETURNING id, name, price_in_cents, created_at;

-- name: GetProductByID :one
SELECT id, name, price_in_cents, created_at
FROM products
WHERE id = $1;

-- name: ListProducts :many
SELECT id, name, price_in_cents, created_at
FROM products
ORDER BY created_at DESC
LIMIT $1 OFFSET $2;
```

> Note that there are comments above the queries. These comments are used by `sqlc` to identify the name of the generated function and the type of result it returns (`:one` for a single row, `:many` for multiple rows, etc). More about the comments can be found in the [sqlc documentation](https://sqlc.dev/docs/concepts/queries/).

After creating the queries you should be able to run the following command to generate the code:

```bash
sqlc generate
```

Now you can use the generated code in your Go project.
